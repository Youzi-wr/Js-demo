<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible"
          content="ie=edge" />
    <title>Document</title>
</head>

<body>
    <div id="app">hello</div>
</body>
<script type="text/javascript">
    var isOrdered = false;

    function iteration(data, key) {
        observal(data[key])
        var dept = new Dep();
        Object.defineProperty(data, key, {
            enumerable: true,
            configurable: true,
            get: function () {
                if (!isOrdered && Dep.target) {
                    dept.add(Dep.target)
                    console.log('在defineProperty中添加订阅器')
                }
                // return value;
            },
            set: function (value) {
                console.log(`Object.defineProperty set: ${value}`)
                dept.notify(value);
            }
        })
    }

    //订阅者
    function observal(obj) {
        if (!obj || typeof obj !== 'object') return;
        Object.keys(obj).forEach(key => {
            iteration(obj, key);
        })
    }

    //订阅器
    function Dep() {
        this.subs = [];
    }

    Dep.prototype = {
        add: function (sub) {
            this.subs.push(sub);

            console.log('dep push')
        },
        notify: function (value) {
            this.subs.forEach(function (sub) {
                sub.update(value);
            })

            console.log('dep notify')
        }
    }

    Dep.target = null;

    //监听者
    function Watcher(vm, exp, cb) {
        this.vm = vm;
        this.exp = exp;
        this.cb = cb;
        this.ordered = false;
        this.value = this.addDep();
    }

    Watcher.prototype = {
        //更新view
        update: function (value) {
            this.value = value;
            this.cb.call(this.vm, value);

            console.log('watch update')
        },
        //添加订阅者
        addDep: function () {
            //通过触发get,在observal中订阅自己
            Dep.target = this;
            this.vm.data[this.exp];
            Dep.target = null;
            isOrdered = true;

            console.log('watch addDep')
        }
    }

    //绑定器
    function SelfVue(data, el, exp) {
        this.data = data;

        observal(data);
        // el.innerHTML = this.data[exp];
        new Watcher(this, exp, function (value) {
            el.innerHTML = value;
            console.log('watch callbakc')
        });
    }

    var ele = document.querySelector('#app');
    var self = new SelfVue({
        name: 'hi'
    }, ele, 'name')

    setTimeout(function () {
        self.data.name = 'hhhh'
    }, 2000)

</script>

</html>