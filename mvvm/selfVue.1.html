<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible"
          content="ie=edge" />
    <title>Document</title>
</head>

<body>
    <div id="app">hello</div>
</body>
<script type="text/javascript">
    //observal
    function observal(data) {
        var dep = new Dept();
        Object.keys(data).forEach(key => {
            let val = data[key];
            if (typeof val == 'object') observal(data[key]);
            Object.defineProperty(data, key, {
                get() {
                    // 将自己添加到订阅器
                    if (Dept.target) {
                        dep.add(Dept.target);
                    }
                    return val;
                },
                set(value) {
                    dep.notify(value);
                }
            })
        })
    }

    // Dept
    Dept.target = null;
    function Dept() {
        this.subs = [];
    }

    Dept.prototype = {
        add(dep) {
            this.subs.push(dep);
        },
        notify(value) {
            // 更新视图
            this.subs.forEach(sub => sub.updateDom(value))
        }
    }

    // watcher
    // function Watcher(data, cb, fun) {
    //     this.data = data;  // 数据源
    //     this.cb = cb;    // 属性
    //     this.fun = fun;
    // }
    // Watcher.prototype = {
    //     updateDom(val){
    //         this.fun(val);
    //     }
    // }

    // Watcher在创建的时候就应该把自己放到订阅器中，所以，添加订阅的动作应该是放在Watcher中
    function Watcher(data, cb, fun) {
        this.data = data;  // 数据源
        this.cb = cb;    // 属性
        this.fun = fun;
        this.value = null;
        this.addSelf();
    }

    // 🔴函数会提升，函数的原型对象不会提升。因此Watcher.prototype不能写在new Watcher下面
    Watcher.prototype = {
        updateDom: function (val) {
            if (val !== this.value) {
                this.value = val;
                this.fun(val);
            }
        },
        addSelf() {
            Dept.target = this;
            this.fun(this.data[this.cb]);  // 添加订阅动作；初始化模板数据的值
            Dept.target = null;
        }
    }

    // binder
    function VueSelf(data, cb, dom) {
        this.data = data;

        observal(data);
        var watch = new Watcher(data, cb, function (value) {
            console.log('update', value)
            dom.innerHTML = value;
        });

        // 添加订阅
        // Dept.target = watch;
        // data[cb];
        // Dept.target = null;

        // return this;  多此一举
    }

    var vm = new VueSelf({
        name: 'tom'
    }, 'name', document.getElementById('app'))

    setTimeout(function () {
        vm.data.name = 'hi, Tom'
    }, 2000)

</script>

</html>