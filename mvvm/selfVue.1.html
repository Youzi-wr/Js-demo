<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible"
          content="ie=edge" />
    <title>Document</title>
</head>

<body>
    <div id="app">hello</div>
</body>
<script type="text/javascript">
    //observal
    function observal(data) {
        var dep = new Dept();
        Object.keys(data).forEach(key => {
            let val = data[key];
            if (typeof val == 'object') observal(data[key]);
            Object.defineProperty(data, key, {
                get() {
                    // å°†è‡ªå·±æ·»åŠ åˆ°è®¢é˜…å™¨
                    if (Dept.target) {
                        dep.add(Dept.target);
                    }
                    return val;
                },
                set(value) {
                    dep.notify(value);
                }
            })
        })
    }

    // Dept
    Dept.target = null;
    function Dept() {
        this.subs = [];
    }

    Dept.prototype = {
        add(dep) {
            this.subs.push(dep);
        },
        notify(value) {
            // æ›´æ–°è§†å›¾
            this.subs.forEach(sub => sub.updateDom(value))
        }
    }

    // watcher
    // function Watcher(data, cb, fun) {
    //     this.data = data;  // æ•°æ®æº
    //     this.cb = cb;    // å±æ€§
    //     this.fun = fun;
    // }
    // Watcher.prototype = {
    //     updateDom(val){
    //         this.fun(val);
    //     }
    // }

    // Watcheråœ¨åˆ›å»ºçš„æ—¶å€™å°±åº”è¯¥æŠŠè‡ªå·±æ”¾åˆ°è®¢é˜…å™¨ä¸­ï¼Œæ‰€ä»¥ï¼Œæ·»åŠ è®¢é˜…çš„åŠ¨ä½œåº”è¯¥æ˜¯æ”¾åœ¨Watcherä¸­
    function Watcher(data, cb, fun) {
        this.data = data;  // æ•°æ®æº
        this.cb = cb;    // å±æ€§
        this.fun = fun;
        this.value = null;
        this.addSelf();
    }

    // ğŸ”´å‡½æ•°ä¼šæå‡ï¼Œå‡½æ•°çš„åŸå‹å¯¹è±¡ä¸ä¼šæå‡ã€‚å› æ­¤Watcher.prototypeä¸èƒ½å†™åœ¨new Watcherä¸‹é¢
    Watcher.prototype = {
        updateDom: function (val) {
            if (val !== this.value) {
                this.value = val;
                this.fun(val);
            }
        },
        addSelf() {
            Dept.target = this;
            this.fun(this.data[this.cb]);  // æ·»åŠ è®¢é˜…åŠ¨ä½œï¼›åˆå§‹åŒ–æ¨¡æ¿æ•°æ®çš„å€¼
            Dept.target = null;
        }
    }

    // binder
    function VueSelf(data, cb, dom) {
        this.data = data;

        observal(data);
        var watch = new Watcher(data, cb, function (value) {
            console.log('update', value)
            dom.innerHTML = value;
        });

        // æ·»åŠ è®¢é˜…
        // Dept.target = watch;
        // data[cb];
        // Dept.target = null;

        // return this;  å¤šæ­¤ä¸€ä¸¾
    }

    var vm = new VueSelf({
        name: 'tom'
    }, 'name', document.getElementById('app'))

    setTimeout(function () {
        vm.data.name = 'hi, Tom'
    }, 2000)

</script>

</html>